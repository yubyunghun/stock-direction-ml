from __future__ import annotations
from pathlib import Path
import json, joblib

_ROOT = Path(__file__).resolve().parents[1]
_ART  = _ROOT / "artifacts"

def _art_dir(asset_class: str) -> Path:
    ac = (asset_class or "equity").lower()
    d = _ART / ac
    return d if d.exists() else _ART

def load_artifacts(asset_class: str = "equity"):
    """
    Load (model, scaler, feature_list, thresholds) for an asset class.

    - Prefers artifacts/<asset_class>/ if present; else artifacts/
    - feature_list.json defines the schema length
    - thresholds file is thresholds.json (plural)
    """
    d = _art_dir(asset_class)

    # feature schema
    fl = d / "feature_list.json"
    if not fl.exists():
        fl = _ART / "feature_list.json"
    if not fl.exists():
        raise FileNotFoundError(f"feature_list.json not found under {d} or {_ART}")
    feature_list = json.loads(fl.read_text())
    n_feats = len(feature_list)

    model = None
    scaler = None

    # Search class dir first (ignore _archive)
    for p in sorted(d.glob("*.joblib")):
        name = p.name.lower()
        if "scaler" in name:
            try:
                obj = joblib.load(p)
                n_in = getattr(obj, "n_features_in_", None)
                if n_in in (n_feats, None):
                    scaler = obj
            except Exception:
                pass
        else:
            try:
                obj = joblib.load(p)
                n_in = getattr(obj, "n_features_in_", None)
                if n_in == n_feats:
                    model = obj
            except Exception:
                pass

    # Fallback to top-level artifacts/
    if model is None:
        for p in sorted(_ART.glob("*.joblib")):
            name = p.name.lower()
            if "scaler" in name:
                continue
            try:
                obj = joblib.load(p)
                n_in = getattr(obj, "n_features_in_", None)
                if n_in == n_feats:
                    model = obj
                    break
            except Exception:
                pass

    if scaler is None:
        for p in sorted(_ART.glob("*.joblib")):
            name = p.name.lower()
            if "scaler" not in name:
                continue
            try:
                obj = joblib.load(p)
                n_in = getattr(obj, "n_features_in_", None)
                if n_in in (n_feats, None):
                    scaler = obj
                    break
            except Exception:
                pass

    if model is None or scaler is None:
        raise RuntimeError(f"Schema-matched artifacts not found (need {n_feats} features) in {d} or {_ART}")

    # thresholds.json (plural) â€” optional
    thr = {}
    for guess in (d / "thresholds.json", _ART / "thresholds.json"):
        if guess.exists():
            try:
                thr = json.loads(guess.read_text())
                break
            except Exception:
                pass

    return model, scaler, feature_list, thr
